<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter&display=swap"
      rel="stylesheet"
    />
    <script src="https://code.highcharts.com/maps/highmaps.js"></script>
    <script src="https://code.highcharts.com/maps/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/maps/modules/accessibility.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f9;
      }
      .dashboard-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        padding: 20px;
      }
      .chart-box {
        background: #fff;
        border-radius: 8px;
        border: 1px solid #ddd;
        padding: 20px;
      }
      .chart {
        width: 100%;
        height: 400px;
      }
      .bar-chart {
        width: 100%;
        height: 300px;
      }
      .map-box {
        grid-column: 1 / -1;
        background: #fff;
        border-radius: 8px;
        border: 1px solid #ddd;
        padding: 20px;
      }
      .map-chart {
        width: 100%;
        height: 600px;
      }
      @media (min-width: 800px) {
        .dashboard-container {
          grid-template-columns: repeat(2, 1fr);
        }
        .map-box {
          grid-column: 1 / 3;
        }
      }
      @media (max-width: 600px) {
        .echarts-title {
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <div class="map-box">
        <div id="europeMap" class="map-chart"></div>
      </div>
      <div class="chart-box">
        <div id="barChart1" class="bar-chart"></div>
      </div>
      <div class="chart-box">
        <div id="barChart2" class="bar-chart"></div>
      </div>
      <div class="chart-box">
        <div id="barChart3" class="bar-chart"></div>
      </div>
      <div class="chart-box">
        <div id="barChart4" class="bar-chart"></div>
      </div>
      <div class="chart-box">
        <div id="chart1" class="chart"></div>
      </div>
      <div class="chart-box">
        <div id="chart2" class="chart"></div>
      </div>
      <div class="chart-box">
        <div id="chart3" class="chart"></div>
      </div>
      <div class="chart-box">
        <div id="chart4" class="chart"></div>
      </div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const colors = ["#133BC7", "#FDC220", "#1BBE6F", "#E63E12", "#502379"];
        function loadCSVData() {
          fetch("./eurosense.csv")
            .then((response) => {
              if (!response.ok) {
                throw new Error(
                  `Failed to fetch the CSV file: ${response.statusText}`
                );
              }
              return response.text();
            })
            .then((csvText) => {
              const jsonData = Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
              }).data;
              createCharts(jsonData);
            })
            .catch((error) => {
              console.error("Error loading CSV data:", error);
            });
        }
        function replaceLongStrings(input) {
          if (input && input.length > 15) {
            return "Other";
          }
          return input || "Not specified";
        }
        function getCountryCode(countryName) {
          const countryCodes = {
            Austria: "AT",
            Belgium: "BE",
            Bulgaria: "BG",
            Croatia: "HR",
            Cyprus: "CY",
            Czechia: "CZ",
            Denmark: "DK",
            Estonia: "EE",
            Finland: "FI",
            France: "FR",
            Germany: "DE",
            Greece: "GR",
            Hungary: "HU",
            Ireland: "IE",
            Italy: "IT",
            Latvia: "LV",
            Lithuania: "LT",
            Luxembourg: "LU",
            Malta: "MT",
            Netherlands: "NL",
            Poland: "PL",
            Portugal: "PT",
            Romania: "RO",
            Slovakia: "SK",
            Slovenia: "SI",
            Spain: "ES",
            Sweden: "SE",
            "United Kingdom": "GB",
            Others: "EU",
          };
          return countryCodes[countryName.trim()] || null;
        }
        function getTop5PlusOthers(countsObj) {
          const sorted = Object.entries(countsObj).sort((a, b) => b[1] - a[1]);
          const top5 = sorted.slice(0, 5);
          const others = sorted.slice(5);
          const othersSum = others.reduce((acc, [_, val]) => acc + val, 0);
          const newDataObj = {};
          top5.forEach(([key, val]) => {
            newDataObj[key] = val;
          });
          if (othersSum > 0) {
            newDataObj["Others"] = othersSum;
          }
          return newDataObj;
        }
        function assignNonConsecutiveColors(dataLength, colorArray) {
          const result = [];
          let lastColor = null;
          let colorIndex = 0;
          for (let i = 0; i < dataLength; i++) {
            let color = colorArray[colorIndex];
            if (color === lastColor) {
              colorIndex = (colorIndex + 1) % colorArray.length;
              color = colorArray[colorIndex];
            }
            result.push(color);
            lastColor = color;
            colorIndex = (colorIndex + 1) % colorArray.length;
          }
          return result;
        }
        function createCharts(data) {
          const experienceFrequencyCounts = {};
          const countryCounts = {};
          const genderCounts = {};
          const ageGroupCounts = {};
          data.forEach((row) => {
            const experience = replaceLongStrings(
              row["6.3 The experience you described was..."]
            );
            experienceFrequencyCounts[experience] =
              (experienceFrequencyCounts[experience] || 0) + 1;
            const country = replaceLongStrings(
              row["6.4 My experience is from..."]
            );
            if (country.trim() !== "" && country.trim() !== "Not specified") {
              countryCounts[country.trim()] =
                (countryCounts[country.trim()] || 0) + 1;
            }
            const gender = replaceLongStrings(row["6.6 I identify as..."]);
            genderCounts[gender] = (genderCounts[gender] || 0) + 1;
            const ageGroup = replaceLongStrings(row["6.7 I am ..."]);
            ageGroupCounts[ageGroup] = (ageGroupCounts[ageGroup] || 0) + 1;
          });
          const experienceFrequencyData = Object.entries(
            experienceFrequencyCounts
          ).map(([name, value]) => ({
            name,
            value,
          }));
          const totalCountries = Object.values(countryCounts).reduce(
            (a, b) => a + b,
            0
          );
          const fullCountryData = Object.entries(countryCounts).map(
            ([name, value]) => ({
              value: ((value / totalCountries) * 100).toFixed(2),
              name,
              code: getCountryCode(name),
            })
          );
          const top5CountryCounts = getTop5PlusOthers(countryCounts);
          const top5CountryData = Object.entries(top5CountryCounts).map(
            ([name, value]) => ({
              name,
              value,
            })
          );
          const genderData = Object.entries(genderCounts).map(
            ([name, value]) => ({
              name,
              value,
            })
          );
          const ageGroupData = Object.entries(ageGroupCounts).map(
            ([name, value]) => ({
              name,
              value,
            })
          );
          const barChartsData = [
            {
              id: "barChart1",
              title:
                "2.1 In the experience you shared, what matters most are...",
              leftLabel: "Values and traditions",
              rightLabel: "Change and innovation",
              xAxisData: [10, 20, 30, 40, 50, 60, 70, 80, 90, 100],
              yAxisValues: [1, 0, 2, 1, 1, 2, 1, 3, 2, 5],
            },
            {
              id: "barChart2",
              title: "2.2 In the experience you shared, others behave...",
              leftLabel: "As expected",
              rightLabel: "Unusually",
              xAxisData: [10, 20, 30, 40, 50, 60, 70, 80, 90, 100],
              yAxisValues: [2, 1, 1, 4, 5, 2, 1, 2, 1, 3],
            },
            {
              id: "barChart3",
              title:
                "2.3 In the experience you shared, everybody is treated...",
              leftLabel: "The same but it's not ok",
              rightLabel: "Differently but it's not ok",
              xAxisData: [10, 20, 30, 40, 50, 60, 70, 80, 90, 100],
              yAxisValues: [1, 2, 0, 1, 0, 2, 3, 5, 2, 4],
            },
            {
              id: "barChart4",
              title:
                "2.4 In the experience you shared, you feel the government...",
              leftLabel: "Interferes too much",
              rightLabel: "Doesn't care at all",
              xAxisData: [10, 20, 30, 40, 50, 60, 70, 80, 90, 100],
              yAxisValues: [0, 1, 1, 2, 3, 1, 2, 6, 3, 5],
            },
          ];
          barChartsData.forEach((cfg) => {
            const barChart = echarts.init(document.getElementById(cfg.id));
            barChart.setOption({
              title: {
                text: cfg.title,
                left: "left",
                textStyle: {
                  fontFamily: "Inter, sans-serif",
                },
              },
              tooltip: {
                trigger: "axis",
              },
              xAxis: {
                type: "category",
                data: cfg.xAxisData,
                axisLabel: {
                  formatter: function (val, idx) {
                    if (idx === 0) return cfg.leftLabel;
                    if (idx === cfg.xAxisData.length - 1) return cfg.rightLabel;
                    return val;
                  },
                },
              },
              yAxis: {
                type: "value",
                name: "Times Answered",
              },
              series: [
                {
                  data: cfg.yAxisValues,
                  type: "bar",
                  itemStyle: {
                    color: "#5B53F6",
                  },
                  barMaxWidth: 30,
                },
              ],
            });
          });
          function buildPieData(originalData) {
            const assignedColors = assignNonConsecutiveColors(
              originalData.length,
              colors
            );
            return originalData.map((item, i) => ({
              name: item.name,
              value: item.value,
              itemStyle: { color: assignedColors[i] },
            }));
          }
          const experiencePieData = buildPieData(experienceFrequencyData);
          const countryPieData = buildPieData(top5CountryData);
          const genderPieData = buildPieData(genderData);
          const agePieData = buildPieData(ageGroupData);
          const chartData = [
            {
              id: "chart1",
              title: "6.3 The experience you described was...",
              data: experiencePieData,
            },
            {
              id: "chart2",
              title: "6.4 My experience is from (Top 5 + Others)...",
              data: countryPieData,
            },
            {
              id: "chart3",
              title: "6.5 I identify as...",
              data: genderPieData,
            },
            {
              id: "chart4",
              title: "6.6 I am ...",
              data: agePieData,
            },
          ];
          chartData.forEach(({ id, title, data }) => {
            const chart = echarts.init(document.getElementById(id));
            chart.setOption({
              title: {
                text: title,
                left: "left",
                textStyle: {
                  fontFamily: "Inter, sans-serif",
                },
              },
              tooltip: { trigger: "item" },
              series: [
                {
                  name: title,
                  type: "pie",
                  radius: "65%",
                  center: ["50%", "50%"],
                  data,
                  emphasis: {
                    itemStyle: {
                      shadowBlur: 10,
                      shadowOffsetX: 0,
                      shadowColor: "rgba(0, 0, 0, 0.5)",
                    },
                  },
                  label: { formatter: "{b}\n({d}%)" },
                },
              ],
            });
          });
          fetch("https://code.highcharts.com/mapdata/custom/europe.topo.json")
            .then((response) => response.json())
            .then((topology) => {
              Highcharts.mapChart("europeMap", {
                chart: {
                  map: topology,
                },
                title: {
                  text: "6.4 My experience is from...",
                  align: "left",
                  style: { fontFamily: "Inter, sans-serif" },
                },
                mapNavigation: {
                  enabled: true,
                  buttonOptions: { verticalAlign: "bottom" },
                },
                colorAxis: {
                  min: 0,
                  max: 100,
                  type: "linear",
                  stops: [
                    [0, "#133BC7"],
                    [0.25, "#FDC220"],
                    [0.5, "#1BBE6F"],
                    [0.75, "#E63E12"],
                    [1, "#502379"],
                  ],
                },
                tooltip: {
                  formatter: function () {
                    const point = this.point;
                    const dataPoint = fullCountryData.find(
                      (d) => d.code === point["iso-a2"]
                    );
                    return `${point.name}: ${
                      dataPoint ? dataPoint.value + "%" : "0%"
                    }`;
                  },
                },
                series: [
                  {
                    data: fullCountryData,
                    name: "Experience Percentage",
                    states: { hover: { color: "#BADA55" } },
                    dataLabels: { enabled: false },
                    joinBy: ["iso-a2", "code"],
                  },
                ],
              });
            });
        }
        loadCSVData();
        window.addEventListener("resize", function () {
          [
            "barChart1",
            "barChart2",
            "barChart3",
            "barChart4",
            "chart1",
            "chart2",
            "chart3",
            "chart4",
          ].forEach((id) => {
            const chartInstance = echarts.getInstanceByDom(
              document.getElementById(id)
            );
            if (chartInstance) {
              chartInstance.resize();
            }
          });
          Highcharts.charts.forEach((chart) => chart?.reflow());
        });
      });
    </script>
  </body>
</html>
